<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä - ‡•®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Mukta', Arial, sans-serif;
            background-color: #d4e4f7;
            padding: 0;
            font-size: 13px;
        }
        
        .page-container {
            background-color: #d4e4f7;
            padding: 10px;
        }
        
        .content-wrapper {
            background-color: #DFE8F6;;
            border: 1px solid #999;
            padding: 15px;
        }
        
        .page-title-section {
            background-color: #d4e4f7;
            padding: 8px 10px;
            margin-bottom: 15px;
            border: 1px solid #5b9bd5;
        }
        
        .page-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }
        
        .print-btn {
            background: linear-gradient(to bottom, #ffffff, #e0e0e0);
            border: 1px solid #999;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .print-btn:hover {
            background: linear-gradient(to bottom, #f5f5f5, #d0d0d0);
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .back-link-panel {
            background-color: #dfe9f6;
            border: 1px solid #5b9bd5;
            padding: 8px 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .back-link-text {
            color: #000;
        }
        
        .back-link-click {
            color: red;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }
        
        .info-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
        }
        
        .info-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .info-field label {
            font-size: 11px;
            color: #333;
            font-weight: normal;
        }
        
        .info-field input {
            padding: 4px 6px;
            border: 1px solid #ccc;
            background-color: #e9ecef;
            font-size: 12px;
        }
        
        .main-layout {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .left-section {
            flex: 1;
            min-width: 0;
        }
        
        .grid-container {
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 0;
            border: 1px solid #b3b3b3;
        }
        
        .right-section {
            width: 300px;
            flex-shrink: 0;
        }
        
        .data-grid {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #b3b3b3;
            font-size: 11px;
        }
        
        .data-grid th {
            background: linear-gradient(to bottom, #5b9bd5, #4a8bc2);
            color: white;
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #4a8bc2;
            font-weight: bold;
            font-size: 10px;
            line-height: 1.3;
        }
        
        .data-grid td {
            padding: 2px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .data-grid input[type="text"] {
            width: 100%;
            padding: 2px;
            border: none;
            text-align: right;
            font-size: 11px;
            background-color: transparent;
        }
        
        .data-grid input[readonly] {
            background-color: #f5f5f5;
        }
        
        .data-grid .total-row {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        .liability-panel {
            background-color: #DFE8F6;;
            border: 1px solid #b3b3b3;
            margin-bottom: 15px;
        }
        
        .panel-header {
            background: linear-gradient(to bottom, #5b9bd5, #4a8bc2);
            color: white;
            padding: 6px 8px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .panel-body {
            padding: 10px;
            background-color: #ffffff;
        }
        
        .panel-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-bottom: 6px;
            align-items: center;
        }
        
        .panel-row label {
            font-size: 11px;
            color: #333;
            text-align: left;
            padding-right: 5px;
        }
        
        .panel-row input {
            padding: 4px 6px;
            border: 1px solid #ccc;
            background-color: #e9ecef;
            text-align: right;
            font-size: 11px;
            min-width: 100px;
            width: 120px;
        }
        
        .installment-panel {
            background-color: #ffffff;
            border: 1px solid #b3b3b3;
            margin-bottom: 15px;
            margin-top: 0;
            width: 100%;
        }
        
        .installment-body {
            padding: 6px;
            background-color: #f8f9fa;
        }
        
        .installment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .installment-table th {
            background-color: #e9ecef;
            padding: 3px;
            border: 1px solid #ddd;
            font-weight: bold;
            text-align: center;
            font-size: 11px;
        }
        
        .installment-table td {
            padding: 2px;
            border: 1px solid #ddd;
        }
        
        .installment-table td:first-child {
            text-align: left;
            padding-left: 3px;
            font-size: 12px;
        }
        
        .installment-table input {
            width: 100%;
            padding: 1px;
            border: none;
            background-color: #e9ecef;
            text-align: right;
            font-size: 12px;
        }
        
        .info-box {
            background-color: #ffff05;
            border: 2px solid #000;
            padding: 8px 10px;
            margin-bottom: 15px;
            color: #000000;
            font-weight: bold;
            font-size: 12px;
            max-width: 400px;
        }
        
        .button-container {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .save-btn {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            color: #000;
            border: 1px solid #999;
            padding: 6px 15px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .save-btn:hover {
            background: linear-gradient(to bottom, #e0e0e0, #c0c0c0);
        }
        
        .back-link-bottom {
            margin-top: 10px;
            font-size: 12px;
            background-color: #dfe9f6;
            border: 1px solid #5b9bd5;
            padding: 8px 10px;
        }
        
        .calc-btn {
            background: linear-gradient(to bottom, #ffffff, #e0e0e0);
            border: 1px solid #000;
            color: blue;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            width: 100%;
            margin-top: 8px;
        }
        
        .calc-btn:hover {
            background: linear-gradient(to bottom, #f5f5f5, #d0d0d0);
        }
        
        .pay-btn {
            background: linear-gradient(to bottom, #70c770, #50a750);
            color: white;
            border: 1px solid #4a8bc2;
            padding: 5px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            width: 100%;
            margin-bottom: 5px;
        }
        
        .pay-btn:hover {
            background: linear-gradient(to bottom, #60b760, #409740);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background-color: #ced9e7;
            border: 2px solid #4a8bc2;
            border-radius: 8px;
            width: 320px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(to bottom, #5b9bd5, #4a8bc2);
            color: white;
            padding: 10px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            border-radius: 6px 6px 0 0;
            position: relative;
        }
        
        .modal-body {
            padding: 30px 20px;
            text-align: center;
        }
        
        .modal-icon {
            font-size: 40px;
            color: #4a8bc2;
            margin-bottom: 15px;
        }
        
        .modal-message {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        .modal-ok-btn {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            border: 1px solid #999;
            padding: 8px 30px;
            margin: 0 auto 15px;
            display: block;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .modal-ok-btn:hover {
            background: linear-gradient(to bottom, #e0e0e0, #c0c0c0);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="content-wrapper">
            <div class="page-title-section">
                <span class="page-title">Annex-2</span>
            </div>
            
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
            
            <div class="header">
                <h1>‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä -‡•®</h1>
            </div>
            
            <!-- Back Link Panel -->
            <div class="back-link-panel">
                <span class="back-link-text">‡§™‡§õ‡§æ‡§°‡§ø ‡§ó‡§è‡§∞ ‡§Ü‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§§‡§Ø ‡§ó‡§∞‡•ç‡§® </span>
                <span class="back-link-click" onclick="goBackToSetAnnex()">‡§Ø‡§π‡§æ‡§Å ‡§ï‡§ø‡§≤‡•ç‡§ï</span>
                <span class="back-link-text"> ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡•§</span>
            </div>
            
            <!-- Information Header -->
            <div class="info-header">
                <div class="info-field">
                    <label>‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§µ‡§∞‡•ç‡§∑:</label>
                    <input type="text" id="fiscalYear" value="2081.082" readonly>
                </div>
                <div class="info-field">
                    <label>‡§ï‡§∞‡§ï‡•ã ‡§ï‡§ø‡§∏‡§ø‡§Æ:</label>
                    <input type="text" id="taxType" value="A" readonly>
                </div>
                <div class="info-field">
                    <label>‡§∏‡§æ‡§Æ‡•ç‡§¨‡§ø‡§ß‡§® ‡§®‡§Ç.:</label>
                    <input type="text" id="submissionNo" value="820076132906" readonly>
                </div>
                <div class="info-field">
                    <label>‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§≤‡•á‡§ñ‡§æ ‡§®‡§Æ‡•ç‡§¨‡§∞:</label>
                    <input type="text" id="pan" value="610015263" readonly>
                </div>
            </div>
            
            <div class="main-layout">
                <!-- Left Section: Main Grid -->
                <div class="left-section">
                    <div class="grid-container">
                        <table class="data-grid">
                        <thead>
                            <tr>
                                <th rowspan="2">S.N.</th>
                                <th rowspan="2">‡•ß<br>Annex Type</th>
                                <th rowspan="2">‡•®<br>Tax Category</th>
                                <th rowspan="2">‡•©<br>Country Code</th>
                                <th rowspan="2">‡•™<br>Inclusions</th>
                                <th rowspan="2">‡•´<br>Income Gain Loss</th>
                                <th rowspan="2">‡•¨<br>Assessable Income</th>
                                <th rowspan="2">‡•≠<br>Retirement Fund</th>
                                <th rowspan="2">‡•Æ<br>Donation</th>
                                <th rowspan="2">‡•Ø<br>Taxable Income</th>
                                <th rowspan="2">‡•ß‡•¶<br>Normal Tax Rate</th>
                                <th rowspan="2">‡•ß‡•ß<br>Concession Category</th>
                                <th rowspan="2">‡•ß‡•®<br>Concession Rate</th>
                                <th rowspan="2">‡•ß‡•©<br>Effective Tax Rate</th>
                                <th rowspan="2">‡•ß‡•™<br>Total Payable Tax</th>
                            </tr>
                        </thead>
                        <tbody id="gridBody">
                            <tr>
                                <td>1</td>
                                <td><input type="text" value="Business" readonly></td>
                                <td><input type="text" value="A2-1" readonly></td>
                                <td><input type="text" value="np" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0"></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="25" readonly></td>
                                <td><input type="text" value="" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="25" readonly></td>
                                <td><input type="text" value="0.00" readonly></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">Total</td>
                                <td><input type="text" id="totalCol4" value="0" readonly></td>
                                <td><input type="text" id="totalCol5" value="0" readonly></td>
                                <td><input type="text" id="totalCol6" value="0" readonly></td>
                                <td><input type="text" id="totalCol7" value="0" readonly></td>
                                <td><input type="text" id="totalCol8" value="0" readonly></td>
                                <td><input type="text" id="totalCol9" value="0" readonly></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td><input type="text" id="totalCol14" value="0.00" readonly></td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                </div>
                
                <!-- Right Section: Tax Liability Panel -->
                <div class="right-section">
                    <div class="liability-panel">
                        <div class="panel-header">‡§ï‡§∞ ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ</div>
                        <div class="panel-body">
                            <div class="panel-row">
                                <label>‡§∂‡•Å‡§≤‡•ç‡§ï ‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ó‡§£‡§®‡§æ ‡§ó‡§∞‡•á‡§ï‡•ã ‡§≠‡§è ‡§ó‡§£‡§®‡§æ‡§ï‡•ã ‡§Ö‡§®‡•ç‡§§‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø</label>
                                <input type="text" id="calcDate" placeholder="YYYY.MM.DD" maxlength="10">
                            </div>
                            <div class="panel-row">
                                <label>‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§ï‡§∞</label>
                                <input type="text" id="totalTax" value="0.00" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§¶‡§´‡§æ ‡•ß‡•ß‡•≠(‡•ß) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                <input type="text" id="totalFee117" value="0.00" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§µ‡•ç‡§Ø‡§æ‡§ú (‡§¶‡§´‡§æ ‡•ß‡•ß‡•Æ)</label>
                                <input type="text" id="interest118" value="0" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§µ‡•ç‡§Ø‡§æ‡§ú (‡§¶‡§´‡§æ ‡•ß‡•ß‡•Ø)</label>
                                <input type="text" id="interest119" value="0.00" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§§‡§ø‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§ï‡§∞</label>
                                <input type="text" id="totalPayable" value="0.00" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§ï‡§∞</label>
                                <input type="text" id="totalPaid" value="0" readonly>
                            </div>
                            <div class="panel-row">
                                <label>‡§¶‡§æ‡§ñ‡§ø‡§≤‡§æ ‡§ó‡§∞‡•ç‡§® ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§ï‡§∞</label>
                                <input type="text" id="remainingTax" value="0" readonly>
                            </div>
                            <button class="pay-btn">‚úì Pay Now</button>
                            <button class="calc-btn">‡§ï‡§∞ ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ ‡§ó‡§£‡§®‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
                        </div>
                    </div>
                </div>
                
                <div style="clear: both;"></div>
            </div>
            
            <!-- Installment Panel -->
            <div class="installment-panel">
                <div class="panel-header">‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§ó‡§£‡§®‡§æ</div>
                <div class="installment-body">
                    <table class="installment-table">
                        <thead>
                            <tr>
                                <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                <th>‡§™‡§π‡§ø‡§≤‡•ã ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡•™‡•¶ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§‡§≤‡•á</th>
                                <th>‡§¶‡•ã‡§∏‡•ç‡§∞‡•ã ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡•≠‡•¶ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§‡§≤‡•á</th>
                                <th>‡§§‡•á‡§∏‡•ç‡§∞‡•ã ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡•ß‡•¶‡•¶ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§‡§≤‡•á</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>‡§Ü‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§∞‡§ï‡§Æ ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§™‡•Å‡§∞‡•ç‡§µ‡§æ‡§Æ‡§æ‡§®‡§ø‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§∞‡§ï‡§Æ ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§∞‡§ï‡§Æ ‡•ß‡•ß‡•Æ(‡•ß)(‡§ï) ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§§‡§ø‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§∞‡§ï‡§Æ ‡•ß‡•ß‡•Æ(‡•ß)(‡§ñ) ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§∞‡§ï‡§Æ ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§ï‡§Æ ‡§∞‡•Å</td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                            <tr>
                                <td>‡§¶‡§´ ‡•ß‡•ß‡•Æ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§ï‡§Æ ‡§∞‡•Å</td>
                                <td></td>
                                <td></td>
                                <td><input type="text" value="0" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Info Box -->
            <div class="info-box">
                ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡•ß‡•¶ ‡§¨‡§æ‡§ü ‡§ï‡§∞ ‡§≠‡•Å‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§¶‡§æ‡§¨‡•Ä ‡§∞‡•Å.0
            </div>
            
            <!-- Save Button -->
            <div class="button-container">
                <button class="save-btn" onclick="saveAnnex2()">
                    <span>üíæ</span>
                    <span>Save Annex 2</span>
                </button>
            </div>
            
            <!-- Bottom Back Link -->
            <div class="back-link-bottom">
                <span class="back-link-text">‡§™‡§õ‡§æ‡§°‡§ø ‡§ó‡§è‡§∞ ‡§Ü‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§§‡§Ø ‡§ó‡§∞‡•ç‡§® </span>
                <span class="back-link-click" onclick="goBackToSetAnnex()">‡§Ø‡§π‡§æ‡§Å ‡§ï‡§ø‡•ç‡§≤‡§ï</span>
                <span class="back-link-text"> ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡•§</span>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">SUCCESS</div>
            <div class="modal-body">
                <div class="modal-icon">‚ìò</div>
                <div class="modal-message">Successfully Saved !!!</div>
            </div>
            <button class="modal-ok-btn" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>
    
    <script>
        // Function to convert AD to BS (Bikram Sambat)
        function convertADtoBS(adDate) {
            const adYear = adDate.getFullYear();
            const adMonth = adDate.getMonth() + 1;
            const adDay = adDate.getDate();
            
            let bsYear = adYear + 57;
            let bsMonth = adMonth + 8;
            let bsDay = adDay + 14;
            
            if (bsMonth > 12) {
                bsMonth -= 12;
            }
            
            if (adMonth <= 4) {
                bsYear = adYear + 56;
            }
            
            const daysInMonth = 30;
            if (bsDay > daysInMonth) {
                bsDay -= daysInMonth;
                bsMonth += 1;
                if (bsMonth > 12) {
                    bsMonth = 1;
                    bsYear += 1;
                }
            }
            
            return bsYear + '.' + String(bsMonth).padStart(2, '0') + '.' + String(bsDay).padStart(2, '0');
        }
        
        // Load taxpayer information from D03 return data
        function loadTaxpayerInfo() {
            const d03Data = JSON.parse(localStorage.getItem('d03_return_data') || '{}');
            
            if (d03Data.fiscalYear) {
                document.getElementById('fiscalYear').value = d03Data.fiscalYear;
            }
            if (d03Data.pan) {
                document.getElementById('pan').value = d03Data.pan;
            }
            
            // Set default tax type
            document.getElementById('taxType').value = '‡§Ü‡§Ø‡§ï‡§∞';
            
            // Set today's date in calcDate field
            setTodaysDate();
            
            // Load Annex 5 data and populate grid
            loadAnnex5DataToGrid();
        }
        
        // Set today's date in the calculation date field
        function setTodaysDate() {
            const calcDateField = document.getElementById('calcDate');
            if (calcDateField && !calcDateField.value) {
                const today = new Date();
                const todayBS = convertADtoBS(today);
                calcDateField.value = todayBS;
                console.log('Set calculation date to BS:', todayBS);
            }
        }
        
        // Load Annex 5 data and populate the grid
        function loadAnnex5DataToGrid() {
            const annex5Data = JSON.parse(localStorage.getItem('d03_annex5_data') || '{}');
            
            console.log('Loading Annex 5 data to grid:', annex5Data);
            
            if (!annex5Data || !annex5Data.taxType) {
                console.log('No Annex 5 data found');
                return;
            }
            
            // Get the first row in the grid body
            const gridBody = document.getElementById('gridBody');
            const firstRow = gridBody.querySelector('tr');
            
            if (!firstRow) {
                console.log('No row found in grid');
                return;
            }
            
            // Extract tax rate percentage from taxRate field (e.g., "25%" -> "25")
            let taxRatePercent = '0';
            if (annex5Data.taxRate) {
                taxRatePercent = annex5Data.taxRate.replace('%', '').trim();
            }
            
            // Calculate values from Annex 5
            const inclusionsTotal = parseFloat(annex5Data.inTotal?.replace(/,/g, '') || 0);
            const deductionsTotal = parseFloat(annex5Data.deTotal?.replace(/,/g, '') || 0);
            const totalDeduction = parseFloat(annex5Data.totalDeduction?.replace(/,/g, '') || 0);
            const businessIncome = parseFloat(annex5Data.businessIncome?.replace(/,/g, '') || 0);
            const miscInclusion = parseFloat(annex5Data.miTotal?.replace(/,/g, '') || 0);
            
            // Calculate income gain/loss (inclusions - deductions)
            const incomeGainLoss = inclusionsTotal - totalDeduction;
            
            // Calculate assessable income (income + misc inclusion)
            const assessableIncome = incomeGainLoss + miscInclusion;
            
            // For retirement fund and donation, use deductions if available
            const retirementFund = parseFloat(annex5Data.de7?.replace(/,/g, '') || 0); // DE7 might be retirement
            const donation = parseFloat(annex5Data.de8?.replace(/,/g, '') || 0); // DE8 might be donation
            
            // Calculate taxable income (assessable - retirement - donation)
            const taxableIncome = Math.max(0, assessableIncome - retirementFund - donation);
            
            // Update grid cells
            const inputs = firstRow.querySelectorAll('input[type="text"]');
            if (inputs.length >= 14) {
                // Column ‡•™ (index 3): Inclusions
                inputs[3].value = inclusionsTotal.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•´ (index 4): Income Gain Loss
                inputs[4].value = incomeGainLoss.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•¨ (index 5): Assessable Income
                inputs[5].value = assessableIncome.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•≠ (index 6): Retirement Fund
                inputs[6].value = retirementFund.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•Æ (index 7): Donation
                inputs[7].value = donation.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•Ø (index 8): Taxable Income
                inputs[8].value = taxableIncome.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Column ‡•ß‡•¶ (index 9): Normal Tax Rate - THIS IS THE KEY FIELD
                inputs[9].value = taxRatePercent;
                
                // Column ‡•ß‡•© (index 12): Effective Tax Rate (same as normal rate for now)
                inputs[12].value = taxRatePercent;
                
                // Column ‡•ß‡•™ (index 13): Total Payable Tax
                const totalPayableTax = (taxableIncome * parseFloat(taxRatePercent)) / 100;
                inputs[13].value = totalPayableTax.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            
            // Update totals row
            updateTotalsRow();
            
            // Update tax liability panel
            updateTaxLiabilityPanel(totalPayableTax);
            
            console.log('Grid populated with all amounts from Annex 5');
            console.log('Tax Rate:', taxRatePercent + '%', 'Taxable Income:', taxableIncome, 'Tax:', totalPayableTax);
        }
        
        // Update tax liability panel with calculated tax
        function updateTaxLiabilityPanel(totalPayableTax) {
            if (totalPayableTax && !isNaN(totalPayableTax)) {
                document.getElementById('totalTax').value = totalPayableTax.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                document.getElementById('totalPayable').value = totalPayableTax.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                document.getElementById('remainingTax').value = totalPayableTax.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }
        
        // Update totals row
        function updateTotalsRow() {
            const gridBody = document.getElementById('gridBody');
            const rows = gridBody.querySelectorAll('tr');
            
            let totalCol4 = 0, totalCol5 = 0, totalCol6 = 0;
            let totalCol7 = 0, totalCol8 = 0, totalCol9 = 0, totalCol14 = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="text"]');
                if (inputs.length >= 14) {
                    totalCol4 += parseFloat(inputs[3].value.replace(/,/g, '') || 0);
                    totalCol5 += parseFloat(inputs[4].value.replace(/,/g, '') || 0);
                    totalCol6 += parseFloat(inputs[5].value.replace(/,/g, '') || 0);
                    totalCol7 += parseFloat(inputs[6].value.replace(/,/g, '') || 0);
                    totalCol8 += parseFloat(inputs[7].value.replace(/,/g, '') || 0);
                    totalCol9 += parseFloat(inputs[8].value.replace(/,/g, '') || 0);
                    totalCol14 += parseFloat(inputs[13].value.replace(/,/g, '') || 0);
                }
            });
            
            // Update total fields
            document.getElementById('totalCol4').value = totalCol4.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol5').value = totalCol5.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol6').value = totalCol6.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol7').value = totalCol7.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol8').value = totalCol8.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol9').value = totalCol9.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('totalCol14').value = totalCol14.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Save Annex 2 data
        function saveAnnex2() {
            const annex2Data = {
                fiscalYear: document.getElementById('fiscalYear').value,
                taxType: document.getElementById('taxType').value,
                submissionNo: document.getElementById('submissionNo').value,
                pan: document.getElementById('pan').value,
                calcDate: document.getElementById('calcDate').value,
                totalTax: document.getElementById('totalTax').value,
                saved: true
            };
            
            localStorage.setItem('d03_annex2_data', JSON.stringify(annex2Data));
            
            // Show success modal
            document.getElementById('successModal').style.display = 'flex';
            
            // Change button text to "Update Annex 2"
            const saveBtn = document.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.querySelector('span:last-child').textContent = 'Update Annex 2';
            }
        }
        
        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        // Load saved data if exists
        function loadAnnex2Data() {
            const savedData = JSON.parse(localStorage.getItem('d03_annex2_data') || '{}');
            
            // Use saved date if exists
            if (savedData.calcDate) {
                const calcDateField = document.getElementById('calcDate');
                if (calcDateField) {
                    calcDateField.value = savedData.calcDate;
                    console.log('Loaded saved calculation date:', savedData.calcDate);
                }
            }
            // Note: If no saved date, setTodaysDate() in loadTaxpayerInfo will set today's date
        }
        
        // Go back to set annex page
        function goBackToSetAnnex() {
            window.parent.postMessage({ action: 'goBackToSetAnnex' }, '*');
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadTaxpayerInfo();
            loadAnnex2Data();
        });
    </script>
</body>
</html>
