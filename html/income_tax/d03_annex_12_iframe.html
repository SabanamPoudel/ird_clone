<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä -‡•ß‡•® - ‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§ï‡§∞ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§¶‡§æ‡§µ‡•Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: #C5D9F1;
            padding: 10px;
        }
        
        .container {
            max-width: 1250px;
            margin: 0 auto;
            background-color: #C5D9F1;
        }
        
        .print-btn {
            padding: 4px 10px;
            background: linear-gradient(to bottom, #f5f5f5 0%, #e8e8e8 100%);
            border: 1px solid #a0a0a0;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .main-panel {
            background-color: #C5D9F1;
            border: 1px solid #8DB4E2;
            padding: 0;
        }
        
        .panel-header {
            background: linear-gradient(to bottom, #DBE5F1 0%, #B7D0E8 100%);
            border-bottom: 1px solid #8DB4E2;
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .back-link {
            color: red;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .form-section {
            background-color: #dfe9f6;
            padding: 10px;
            margin: 5px;
        }
        
        .section-title {
            background: linear-gradient(to bottom, #DBE5F1 0%, #B7D0E8 100%);
            border: 1px solid #8DB4E2;
            padding: 6px 10px;
            font-weight: normal;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .add-new-btn {
            padding: 4px 10px;
            background: linear-gradient(to bottom, #f5f5f5 0%, #e8e8e8 100%);
            border: 1px solid #a0a0a0;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
            margin: 5px 0;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .add-new-btn:hover {
            background: linear-gradient(to bottom, #e8e8e8 0%, #d8d8d8 100%);
        }
        
        .add-new-btn span:first-child {
            color: green;
            font-size: 14px;
        }
        
        .column-labels {
            border-left: 1px solid #B7D0E8;
            border-right: 1px solid #B7D0E8;
            background-color: #dfe9f6;
            padding: 3px 0;
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .column-labels span {
            display: table-cell;
            text-align: center;
            font-size: 13px;
            padding: 3px 0;
            border-right: 1px solid #B7D0E8;
            vertical-align: middle;
        }
        
        .column-labels span:last-child {
            border-right: none;
        }
        
        .col-spacer {
            width: 25px;
        }
        
        .col-1 {
            width: 200px;
        }
        
        .col-2 {
            width: 150px;
        }
        
        .col-3 {
            width: 150px;
        }
        
        .col-4 {
            width: 140px;
        }
        
        .col-actions {
            width: 100px;
        }
        
        .table-container {
            background-color: white;
            border: 1px solid #B7D0E8;
            min-height: 250px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        
        th {
            background-color: #f3f3f4;
            border: 1px solid #8DB4E2;
            padding: 6px;
            text-align: left;
            font-size: 12px;
            font-weight: normal;
        }
        
        th.center {
            text-align: center;
        }
        
        td {
            border: 1px solid #ddd;
            padding: 4px;
            font-size: 12px;
        }
        
        .row-number {
            width: 25px;
            text-align: center;
            background-color: #f3f3f4;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 3px;
            border: 1px solid #ccc;
            font-size: 12px;
        }
        
        input[type="number"] {
            text-align: right;
        }
        
        .action-icon {
            cursor: pointer;
            padding: 0 4px;
            font-size: 14px;
        }
        
        .edit-icon {
            color: blue;
        }
        
        .delete-icon {
            color: red;
        }
        
        .total-row {
            background-color: white;
        }
        
        .total-row td {
            padding: 5px;
        }
        
        .total-label {
            text-align: left;
            padding-left: 25px;
            font-size: 12px;
        }
        
        .button-group {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            padding: 5px 0;
        }
        
        .save-btn,
        .update-btn,
        .delete-btn {
            padding: 4px 12px;
            background: linear-gradient(to bottom, #f5f5f5 0%, #e8e8e8 100%);
            border: 1px solid #a0a0a0;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .save-btn:hover,
        .update-btn:hover,
        .delete-btn:hover {
            background: linear-gradient(to bottom, #e8e8e8 0%, #d8d8d8 100%);
        }
        
        .delete-btn {
            display: none;
        }
        
        .back-link-bottom {
            margin-top: 8px;
            font-size: 12px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            align-items: flex-start;
            justify-content: center;
        }
        
        .modal-content {
            background: #d4e4f7;
            border-radius: 6px;
            min-width: 380px;
            max-width: 90vw;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.15);
            position: relative;
            border: 1.5px solid #b5cbe7;
            margin-top: 100px;
        }
        
        .modal-header {
            padding: 10px 18px;
            font-size: 15px;
            font-weight: bold;
            color: #1a4b8c;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #b5cbe7;
        }
        
        .close {
            position: absolute;
            top: 8px;
            right: 14px;
            font-size: 20px;
            cursor: pointer;
            color: #888;
        }
        
        .modal-body {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px 18px;
        }
        
        .modal-icon {
            margin-top: 2px;
        }
        
        .modal-message {
            font-size: 14px;
            color: #222;
            line-height: 1.5;
        }
        
        .modal-footer {
            text-align: center;
            padding: 0 18px 12px 18px;
        }
        
        .modal-btn-primary,
        .modal-btn-secondary {
            padding: 4px 28px;
            background: #e3eaf3;
            border: 1.5px solid #b5cbe7;
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .modal-btn-primary:hover,
        .modal-btn-secondary:hover {
            background: #d4e4f7;
        }

        /* Disclaimer Banner */
        .disclaimer-banner {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px 20px;
            margin: 10px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.6;
            text-align: left;
        }

        @media screen and (max-width: 768px) {
            .disclaimer-banner {
                font-size: 12px;
                padding: 12px 15px;
            }
        }

        @media screen and (max-width: 480px) {
            .disclaimer-banner {
                font-size: 11px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        <strong>‚ö†Ô∏è IMPORTANT NOTICE:</strong> This website is provided strictly for training and demonstration purposes only. 
        It is NOT connected to the official Inland Revenue Department (IRD) of Nepal. 
        Do not enter any real, sensitive, or confidential taxpayer information. 
        Any data entered here will not be processed or submitted to the actual IRD system. 
        For official tax filing, please visit the authentic IRD portal.
    </div>

    <div class="container">
        <button class="print-btn" onclick="window.print()">
            <span>üñ®Ô∏è</span>
            <span>Print</span>
        </button>
        
        <div class="title">‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä -‡•ß‡•®</div>
        
        <div class="main-panel">
            <div class="panel-header">
                ‡§™‡§õ‡§æ‡§°‡§ø ‡§ó‡§è‡§∞ ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§§‡§Ø ‡§ó‡§∞‡•ç‡§® <span class="back-link" onclick="goBack()">‡§Ø‡§π‡§æ‡§Å ‡§ï‡§ø‡•ç‡§≤‡§ï</span> ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡•§
            </div>
            
            <div class="form-section">
                <div class="section-title">‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§ï‡§∞ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§¶‡§æ‡§µ‡•Ä</div>
                
                <button class="add-new-btn" onclick="addNewRow()">
                    <span>‚ûï</span>
                    <span>Add New</span>
                </button>
                
                <div class="column-labels">
                    <span class="col-spacer"></span>
                    <span class="col-1">‡•ß</span>
                    <span class="col-2">‡•®</span>
                    <span class="col-3">‡•©</span>
                    <span class="col-4">‡•™</span>
                    <span class="col-actions"></span>
                </div>
                
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th class="row-number center">&nbsp;</th>
                                <th style="width: 200px;">‡§Ü‡§Ø ‡§∏‡•ç‡§∞‡•ã‡§§‡§ï‡•ã ‡§Æ‡•Å‡§≤‡•Å‡§ï</th>
                                <th style="width: 150px; text-align: center;">‡§ó‡§§ ‡§Ü‡§Ø‡§¨‡§∞‡•ç‡§∑ ‡§∏‡§Æ‡•ç‡§Æ‡§ï‡•ã ‡§Æ‡§ø‡§≤‡§æ‡§®<br>‡§ó‡§∞‡•ç‡§® ‡§¨‡§æ‡§Ç‡§ï‡•Ä ‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§ï‡§∞</th>
                                <th style="width: 150px; text-align: center;">‡§Ø‡§∏ ‡§Ü‡§Ø‡§¨‡§∞‡•ç‡§∑‡§Æ‡§æ ‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§§‡§ø‡§∞‡•á‡§ï‡•ã ‡§ï‡§∞</th>
                                <th style="width: 140px; text-align: center;">‡§Ø‡§∏ ‡§Ü‡§Ø‡§¨‡§∞‡•ç‡§∑‡§Æ‡§æ ‡§µ‡§ø‡§¶‡•á‡§∂‡•Ä ‡§ï‡§∞ ‡§¶‡§æ‡§µ‡•Ä</th>
                                <th style="width: 100px; text-align: center;">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; background-color: white; margin-top: -1px; table-layout: fixed;">
                    <tr class="total-row">
                        <td style="border: 1px solid #B7D0E8; width: 25px;">&nbsp;</td>
                        <td class="total-label" style="border: 1px solid #B7D0E8; width: 200px;">Total Expenses</td>
                        <td style="border: 1px solid #B7D0E8; width: 150px; text-align: center;"><input type="text" id="totalCol2" readonly value="" style="background: white; border: none; text-align: center; width: 100%;"></td>
                        <td style="border: 1px solid #B7D0E8; width: 150px; text-align: center;"><input type="text" id="totalCol3" readonly value="" style="background: white; border: none; text-align: center; width: 100%;"></td>
                        <td style="border: 1px solid #B7D0E8; width: 140px; text-align: center;"><input type="text" id="totalCol4" readonly value="" style="background: white; border: none; text-align: center; width: 100%;"></td>
                        <td style="border: 1px solid #B7D0E8; width: 100px;">&nbsp;</td>
                    </tr>
                </table>
                
                <div class="button-group">
                    <button class="save-btn" id="saveBtn" onclick="saveAnnex12()">
                        <span>üíæ</span>
                        <span>Save Annex 12</span>
                    </button>
                    <button class="update-btn" id="updateBtn" style="display: none;" onclick="updateAnnex12()">
                        <span>‚úèÔ∏è</span>
                        <span>Update</span>
                    </button>
                    <button class="delete-btn" id="deleteBtn" onclick="confirmDelete()">
                        <span>üóëÔ∏è</span>
                        <span>Delete</span>
                    </button>
                </div>
                
                <div class="back-link-bottom">
                    ‡§™‡§õ‡§æ‡§°‡§ø ‡§ó‡§è‡§∞ ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§§‡§Ø ‡§ó‡§∞‡•ç‡§® <span class="back-link" onclick="goBack()">‡§Ø‡§π‡§æ‡§Å ‡§ï‡§ø‡•ç‡§≤‡§ï</span> ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡•§
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                SUCCESS
                <span class="close" onclick="closeSuccessModal()">&times;</span>
            </div>
            <div class="modal-body" style="display: flex; align-items: center; gap: 15px;">
                <div class="modal-icon" style="flex-shrink: 0;">
                    <svg width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="24" fill="#b5cbe7"/>
                        <text x="24" y="33" text-anchor="middle" font-size="28" fill="#1a4b8c" font-family="Arial, sans-serif" font-weight="bold">i</text>
                    </svg>
                </div>
                <div class="modal-message" style="flex: 1; text-align: left;">
                    Successfully Updated.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-primary" onclick="closeSuccessModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Confirm Action
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <div class="modal-body" style="display: flex; align-items: center; gap: 15px;">
                <div class="modal-icon" style="flex-shrink: 0;">
                    <svg width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="24" fill="#b5cbe7"/>
                        <text x="24" y="33" text-anchor="middle" font-size="28" fill="#1a4b8c" font-family="Arial, sans-serif" font-weight="bold">?</text>
                    </svg>
                </div>
                <div class="modal-message" style="flex: 1; text-align: left;">
                    ‡§ï‡•á ‡§§‡§™‡§æ‡§à‡§Ç ‡§™‡§õ‡§æ‡§°‡§ø ‡§ó‡§è‡§∞ ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§§‡§Ø ‡§ó‡§∞‡•ç‡§® ‡§ö‡§æ‡§π‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ?
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-primary" onclick="confirmGoBack()">Yes</button>
                <button class="modal-btn-secondary" onclick="closeConfirmModal()">No</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                CONFIRM DELETE
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32">
                        <circle cx="16" cy="16" r="16" fill="#b5cbe7"/>
                        <text x="16" y="22" text-anchor="middle" font-size="20" fill="#1a4b8c" font-family="Arial, sans-serif">!</text>
                    </svg>
                </div>
                <div class="modal-message">
                    Are you sure you want to delete all Annex 12 data?
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-primary" onclick="deleteAnnex12()">Yes</button>
                <button class="modal-btn-secondary" onclick="closeDeleteModal()">No</button>
            </div>
        </div>
    </div>
    
    <script>
        let rowData = [];
        let editingIndex = -1;
        let isAddingNew = false;
        
        // List of countries
        const countries = [
            'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 
            'Australia', 'Austria', 'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 
            'Belize', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 
            'Burkina Faso', 'Burundi', 'Cambodia', 'Cameroon', 'Canada', 'Cape Verde', 'Central African Republic', 'Chad', 
            'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 
            'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic', 'East Timor', 'Ecuador', 'Egypt', 'El Salvador', 
            'Equatorial Guinea', 'Eritrea', 'Estonia', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon', 'Gambia', 'Georgia', 
            'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana', 'Haiti', 'Honduras', 
            'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast', 'Jamaica', 
            'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'North Korea', 'South Korea', 'Kosovo', 'Kuwait', 'Kyrgyzstan', 
            'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg', 'Macedonia', 
            'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 
            'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia', 
            'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'Norway', 'Oman', 'Pakistan', 
            'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar', 
            'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 
            'San Marino', 'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 
            'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 
            'Suriname', 'Swaziland', 'Sweden', 'Switzerland', 'Syria', 'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Togo', 
            'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu', 'Uganda', 'Ukraine', 'United Arab Emirates', 
            'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam', 'Yemen', 
            'Zambia', 'Zimbabwe'
        ];
        
        function getCountryOptions(selectedCountry = '') {
            let options = '<option value="">Select ...</option>';
            countries.forEach(country => {
                const selected = country === selectedCountry ? 'selected' : '';
                options += `<option value="${country}" ${selected}>${country}</option>`;
            });
            return options;
        }
        
        // Load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadAnnex12Data();
        });
        
        function addNewRow() {
            isAddingNew = true;
            const tbody = document.getElementById('tableBody');
            
            // Create new editable row
            const tr = document.createElement('tr');
            tr.id = 'editRow';
            tr.style.backgroundColor = '#f9f9f9';
            tr.innerHTML = `
                <td class="row-number">${rowData.length + 1}</td>
                <td>
                    <select id="countryInput" style="width: 100%; padding: 3px; font-size: 12px;">
                        ${getCountryOptions()}
                    </select>
                </td>
                <td><input type="number" id="col2Input" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td><input type="number" id="col3Input" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td><input type="number" id="col4Input" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td style="text-align: center;">
                    <button onclick="saveNewRow()" style="padding: 3px 12px; margin-right: 5px; font-size: 11px; cursor: pointer;">Update</button>
                    <button onclick="cancelNewRow()" style="padding: 3px 12px; font-size: 11px; cursor: pointer;">Cancel</button>
                </td>
            `;
            
            tbody.appendChild(tr);
        }
        
        function saveNewRow() {
            const country = document.getElementById('countryInput').value;
            const col2 = document.getElementById('col2Input').value;
            const col3 = document.getElementById('col3Input').value;
            const col4 = document.getElementById('col4Input').value;
            
            if (!country) {
                alert('Please select a country.');
                return;
            }
            
            const newRow = {
                country: country,
                col2: parseFloat(col2) || 0,
                col3: parseFloat(col3) || 0,
                col4: parseFloat(col4) || 0
            };
            
            rowData.push(newRow);
            isAddingNew = false;
            renderTable();
            calculateTotals();
        }
        
        function cancelNewRow() {
            const editRow = document.getElementById('editRow');
            if (editRow) {
                editRow.remove();
            }
            isAddingNew = false;
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            rowData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="row-number">${index + 1}</td>
                    <td>${row.country}</td>
                    <td style="text-align: right;">${row.col2.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="text-align: right;">${row.col3.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="text-align: right;">${row.col4.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="text-align: center;">
                        <span class="action-icon edit-icon" onclick="editRow(${index})" title="Edit">‚úèÔ∏è</span>
                        <span class="action-icon delete-icon" onclick="deleteRow(${index})" title="Delete">‚äñ</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Calculate and update totals
            calculateTotals();
        }
        
        function editRow(index) {
            const row = rowData[index];
            const tbody = document.getElementById('tableBody');
            const tr = tbody.children[index];
            
            tr.id = 'editRow';
            tr.style.backgroundColor = '#f9f9f9';
            tr.innerHTML = `
                <td class="row-number">${index + 1}</td>
                <td>
                    <select id="countryInput" style="width: 100%; padding: 3px; font-size: 12px;">
                        ${getCountryOptions(row.country)}
                    </select>
                </td>
                <td><input type="number" id="col2Input" value="${row.col2}" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td><input type="number" id="col3Input" value="${row.col3}" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td><input type="number" id="col4Input" value="${row.col4}" oninput="updateTotalsLive()" style="width: 100%; text-align: right; padding: 3px; font-size: 12px;" step="0.01"></td>
                <td style="text-align: center;">
                    <button onclick="updateRow(${index})" style="padding: 3px 12px; margin-right: 5px; font-size: 11px; cursor: pointer;">Update</button>
                    <button onclick="cancelEdit(${index})" style="padding: 3px 12px; font-size: 11px; cursor: pointer;">Cancel</button>
                </td>
            `;
            
            editingIndex = index;
        }
        
        function updateRow(index) {
            const country = document.getElementById('countryInput').value;
            const col2 = document.getElementById('col2Input').value;
            const col3 = document.getElementById('col3Input').value;
            const col4 = document.getElementById('col4Input').value;
            
            if (!country) {
                alert('Please select a country.');
                return;
            }
            
            rowData[index] = {
                country: country,
                col2: parseFloat(col2) || 0,
                col3: parseFloat(col3) || 0,
                col4: parseFloat(col4) || 0
            };
            
            editingIndex = -1;
            renderTable();
            calculateTotals();
        }
        
        function cancelEdit(index) {
            editingIndex = -1;
            renderTable();
        }
        
        function deleteRow(index) {
            if (confirm('Are you sure you want to delete this row?')) {
                rowData.splice(index, 1);
                renderTable();
                calculateTotals();
            }
        }
        
        function calculateTotals() {
            if (rowData.length === 0) {
                document.getElementById('totalCol2').value = '';
                document.getElementById('totalCol3').value = '';
                document.getElementById('totalCol4').value = '';
                return;
            }
            
            let total2 = 0, total3 = 0, total4 = 0;
            
            rowData.forEach(row => {
                total2 += row.col2;
                total3 += row.col3;
                total4 += row.col4;
            });
            
            document.getElementById('totalCol2').value = total2.toFixed(2);
            document.getElementById('totalCol3').value = total3.toFixed(2);
            document.getElementById('totalCol4').value = total4.toFixed(2);
        }
        
        function updateTotalsLive() {
            // Calculate totals including current input values
            let total2 = 0, total3 = 0, total4 = 0;
            
            // Add saved rows
            rowData.forEach(row => {
                total2 += row.col2;
                total3 += row.col3;
                total4 += row.col4;
            });
            
            // Add current editing values if they exist
            const col2Input = document.getElementById('col2Input');
            const col3Input = document.getElementById('col3Input');
            const col4Input = document.getElementById('col4Input');
            
            if (col2Input) {
                total2 += parseFloat(col2Input.value) || 0;
            }
            if (col3Input) {
                total3 += parseFloat(col3Input.value) || 0;
            }
            if (col4Input) {
                total4 += parseFloat(col4Input.value) || 0;
            }
            
            // Update display
            document.getElementById('totalCol2').value = total2.toFixed(2);
            document.getElementById('totalCol3').value = total3.toFixed(2);
            document.getElementById('totalCol4').value = total4.toFixed(2);
        }
        
        function saveAnnex12() {
            localStorage.setItem('annex12_data', JSON.stringify(rowData));
            localStorage.setItem('d03_annex12_saved', 'true');
            
            // Show success modal
            document.getElementById('successModal').style.display = 'flex';
            
            // Notify parent window
            window.parent.postMessage({ type: 'annex12Saved' }, '*');
        }
        
        function updateAnnex12() {
            saveAnnex12();
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            
            // Switch to update mode
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'inline-block';
            document.getElementById('deleteBtn').style.display = 'inline-block';
        }
        
        function confirmDelete() {
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        function deleteAnnex12() {
            localStorage.removeItem('annex12_data');
            localStorage.removeItem('d03_annex12_saved');
            
            // Reset form
            rowData = [];
            renderTable();
            calculateTotals();
            
            // Switch back to save mode
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            
            closeDeleteModal();
            
            // Notify parent window
            window.parent.postMessage({ type: 'annex12Deleted' }, '*');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        function loadAnnex12Data() {
            const savedData = localStorage.getItem('annex12_data');
            const isSaved = localStorage.getItem('d03_annex12_saved');
            
            if (savedData) {
                rowData = JSON.parse(savedData);
                renderTable();
                calculateTotals();
            }
            
            if (isSaved === 'true') {
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('deleteBtn').style.display = 'inline-block';
            }
        }
        
        function goBack() {
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        function confirmGoBack() {
            window.location.href = 'd03_set_annex.html';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
    </script>
</body>
</html>
